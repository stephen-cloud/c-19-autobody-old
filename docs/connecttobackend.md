!!! error
    Where should we put this? What are the responses?

```shell
amplify update api
amplify push
```

!!! note
    We're going to keep the state as-is for now. You'll see that the way we use it is inefficient because we're fetching all vehicles every time we make a change. The basic table provided by React Material does not provide pagination with lazy loading. We'll get to a solution for this in a bit. But it's a bit complicated and might throw us off the scent if we do that now.

    If you're curious, we're going to show you how to use Material Table, <https://material-table.com> for lots of table goodness.

If you're sharp-eyed, you notice Amplify created configuration in `aws-exports.js`, which contains something like.

```javascript
// WARNING: DO NOT EDIT. This file is automatically generated by AWS Amplify. It will be overwritten.

const awsmobile = {
    "aws_project_region": "us-east-1",
    "aws_appsync_graphqlEndpoint": "https://xxx.appsync-api.us-east-1.amazonaws.com/graphql",
    "aws_appsync_region": "us-east-1",
    "aws_appsync_authenticationType": "API_KEY",
    "aws_appsync_apiKey": "xxx"
};

export default awsmobile;
```

Let Amplify maintain this file just like it says.

## Initialize Amplify

We need to import and initialize Amplify with the configuration in `awsmobile`. We only need to do it once, so let's put it in `index.tsx`.

!!! note
    This goes in `index.tsx`.

```typescript
import Amplify from '@aws-amplify/core';
import amplify_configuration from './aws-exports';

Amplify.configure(amplify_configuration);
```

## Use the DataStore API in `Vehicles.tsx`

The `DataStore` API is an alternative to using the raw GraphQL API, which can get a bit fiddly to get right at first.

!!! note
    This goes in `Vehicles.tsx`.

## Using `DataStore`

Import it.

```typescript
import { DataStore } from '@aws-amplify/datastore';
```

`DataStore` functions return `Promise`s. So we have to handle that in `addVehicle()` where we save a vehicle, now using `DataStore.save()`.

```typescript
    function addVehicle() {
        const make = uuid();
        const model = uuid();
        const mileage = Math.floor(Math.random() * 100000) + 1
        const vehicle = new Vehicle({ make, model, mileage });

        DataStore
            .save(vehicle)
            .then(console.log)
            .catch(console.error);
    }
```

That's also true for `DataStore.query()`, the way we're going to fetch data now.

!!! note
    The default query is all objects. We can supply predicates and pagination details in the query. We'll get to that when we use <https://material-table.com/#/>, which lazy loads as it paginates.

We use the `setVehicles(...)` React hook as before. But this time with the results of the DataStore query. Here's that function.

```typescript
    function fetchAll() {
        DataStore
            .query(Vehicle)
            .then(setVehicles)
            .catch(console.error);
    };
```

## Handle subscription events

We're going to subscribe to changes in the back-end data and reload all the vehicles every time we get an event. 

This is AWS AppSync at work. See <https://docs.aws.amazon.com/appsync/index.html>.

This function is handy for tracking events as we get them.

```typescript
import { DataStore, SubscriptionMessage } from '@aws-amplify/datastore';
...

    function subscriber(subscriptionMessage: SubscriptionMessage<Vehicle>) {
        console.log('subscriptionMessage', subscriptionMessage);

        fetchAll();
    }
```

## Observe changes and subscribe to them

Now that we have a functions `fetchAll()` and `subscriber()`, let's put them together in a `withEffect()`. Read that as "with side-effect". You can find out more here: <https://reactjs.org/docs/hooks-effect.html>. 

```typescript
import React, { useEffect } from 'react';
```

```typescript
    useEffect(() => {
        fetchAll();

        function subscriber(subscriptionMessage: SubscriptionMessage<Vehicle>) {
            console.log('subscriptionMessage', subscriptionMessage);
    
            fetchAll();
        }
    
        const subscription = DataStore
            .observe(Vehicle)
            .subscribe(subscriber);

        return () => { subscription.unsubscribe(); };
    }, []);
```

Now whenever AppSync sends us an update we read the data from DynamoDB and display it.

So now we have

| What | How |
| --- | --- |
| `<Button>` click handler | `onClick()` on `<Button>` definition |
| Adding a (random) vehicle | `addVehicle()` in `onClick()`, which calls the DataStore to save the new vehicle. | 
| A subscription event handler | `subscriber()` |
| A subscriber to changes in the Vehicle database | In `useEffect()` |

!!! note
    I guarantee this all seems totally useless and unnecessary at the moment. 
    
    Just wait. Prepare to be astounded.

Let's try it anyway. (`yarn start` as usual.)

## Now for the astonishing bit

Open up another browser <http://localhost:3000> and watch what happens when you dd a vehicle.

You just wrote Google docs for cars. 

## The upshot

We configured Amplify. We created an Amplify DataSource observer and subscribed to events from it. We learned just a little about `useEffect()` and glued that all together. We were a bit astonished at what that allowed us to do if we're being honest.

The complete `Vehicles.tsx` is

```typescript
import React, { useEffect } from 'react';
import { Button, Table, TableHead, TableRow, TableCell, TableBody, Grid } from '@material-ui/core';
import { Vehicle } from './models';
import { uuid } from 'uuidv4';
import { DataStore, SubscriptionMessage } from '@aws-amplify/datastore';

function Vehicles() {
    const [vehicles, setVehicles] = React.useState<Vehicle[]>([]);

    function fetchAll() {
        DataStore
            .query(Vehicle)
            .then(setVehicles)
            .catch(console.error);
    };

    useEffect(() => {
        fetchAll();

        function subscriber(subscriptionMessage: SubscriptionMessage<Vehicle>) {
            console.log('subscriptionMessage', subscriptionMessage);
    
            fetchAll();
        }
    
        const subscription = DataStore
            .observe(Vehicle)
            .subscribe(subscriber);

        return () => { subscription.unsubscribe(); };
    }, []);

    function addVehicle() {
        const make = uuid();
        const model = uuid();
        const mileage = Math.floor(Math.random() * 100000) + 1
        const vehicle = new Vehicle({ make, model, mileage });

        DataStore
            .save(vehicle)
            .then(console.log)
            .catch(console.error);
    }

    function onClick(event: React.MouseEvent) {
        addVehicle();

        event.preventDefault();
    }

    return (
        <Grid container spacing={2}>
            <Grid item xs={12} sm={3}>
                <Button onClick={onClick}>Add vehicle</Button>
            </Grid>
            <Grid item xs={12} sm={9}>
                <Table>
                    <TableHead>
                        <TableRow>
                            <TableCell>Make</TableCell>
                            <TableCell>Model</TableCell>
                            <TableCell>Mileage</TableCell>
                        </TableRow>
                    </TableHead>
                    <TableBody>
                        {
                            vehicles.map((vehicle) => (
                                <TableRow>
                                    <TableCell>{vehicle.make}</TableCell>
                                    <TableCell>{vehicle.model}</TableCell>
                                    <TableCell align="right">{vehicle.mileage}</TableCell>
                                </TableRow>
                            ))
                        }
                    </TableBody>
                </Table>
            </Grid>
        </Grid>
    );
}

export default Vehicles;
```